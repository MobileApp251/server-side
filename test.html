<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jira Clone WebSocket Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        #logs { height: 300px; overflow-y: scroll; background: #f0f0f0; border: 1px solid #999; padding: 10px; font-family: monospace; }
        .log-connect { color: green; font-weight: bold; }
        .log-error { color: red; font-weight: bold; }
        .log-message { color: blue; font-weight: bold; font-size: 1.1em; }
    </style>
</head>
<body>
    <h2>ğŸš€ Test WebSocket Jira Clone (STOMP)</h2>

    <div class="box">
        <label><b>1. DÃ¡n Token JWT vÃ o Ä‘Ã¢y (KhÃ´ng cáº§n chá»¯ Bearer):</b></label><br>
        <textarea id="token" rows="3" style="width: 100%; margin-top: 5px;"></textarea>
        <br><br>
        <button onclick="connect()">ğŸ”Œ Káº¾T Ná»I (CONNECT)</button>
        <button onclick="disconnect()" disabled id="btnDisconnect">âŒ NGáº®T Káº¾T Ná»I</button>
    </div>

    <div class="box">
        <h3>ğŸ“œ Tráº¡ng thÃ¡i & Tin nháº¯n:</h3>
        <div id="logs"></div>
    </div>

    <script>
        var stompClient = null;

        function log(msg, className) {
            var logs = document.getElementById("logs");
            var div = document.createElement("div");
            div.className = className || "";
            div.innerText = new Date().toLocaleTimeString() + ": " + msg;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function connect() {
            var token = document.getElementById("token").value.trim();
            //if (!token) { alert("ChÆ°a nháº­p Token!"); return; }

            // URL nÃ y dÃ¹ng SockJS, khá»›p vá»›i code .withSockJS() cá»§a báº¡n
            var socket = new SockJS('http://localhost:8081/ws'); 
            stompClient = Stomp.over(socket);

            // Táº¯t debug console cho Ä‘á»¡ rá»‘i
            stompClient.debug = null; 

            var headers = {
                'Authorization': 'Bearer ' + token
            };

            log("Äang káº¿t ná»‘i tá»›i server...", "");

            stompClient.connect(headers, function (frame) {
                log(">>> Káº¾T Ná»I THÃ€NH CÃ”NG! (CONNECTED)", "log-connect");
                log("User session: " + frame.headers['user-name'], "log-connect");
                document.getElementById("btnDisconnect").disabled = false;

                // Subscribe Ä‘Ãºng kÃªnh /user/queue/notification nhÆ° trong code Java cá»§a báº¡n
                // LÆ°u Ã½: Client dÃ¹ng /user/queue/notification, Server sáº½ tá»± map vÃ o session
                var subUrl = '/user/queue/notification'; 
                
                log("Äang Ä‘Äƒng kÃ½ láº¯ng nghe táº¡i: " + subUrl, "");
                
                stompClient.subscribe(subUrl, function (output) {
                    log("ğŸ“© NHáº¬N ÄÆ¯á»¢C THÃ”NG BÃO: " + output.body, "log-message");
                });

            }, function (error) {
                log("Lá»–I Káº¾T Ná»I: " + error, "log-error");
                log("Check láº¡i Token hoáº·c Log Server xem cÃ³ lá»—i 401/403 khÃ´ng.", "log-error");
                log(error.message, "log-error")
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            log("ÄÃ£ ngáº¯t káº¿t ná»‘i.", "");
            document.getElementById("btnDisconnect").disabled = true;
        }
    </script>
</body>
</html>