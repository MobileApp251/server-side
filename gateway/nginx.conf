events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # BẮT BUỘC: Resolver để phân giải tên miền Google/Render
    resolver 8.8.8.8 1.1.1.1 valid=30s;

    server {
        listen 80;

        # --- CẤU HÌNH CHO JAVA SPRING BOOT ---
        location /api/java/ {
            # 1. URL công khai của Spring Boot (Lấy từ Dashboard của bạn)
            # Lưu ý: Phải dùng https:// và KHÔNG có cổng 8080/8081 (Web Service public chạy port 443 ẩn)
            set $backend_java "https://server-side-vp3t.onrender.com"; 
            
            # Rewrite: Xóa prefix /api/java/ trước khi gửi đi
            rewrite ^/api/java/(.*) /$1 break;
            
            proxy_pass $backend_java;
            
            # Các cấu hình bắt buộc khi proxy sang HTTPS
            proxy_ssl_server_name on;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            proxy_set_header Host server-side-vp3t.onrender.com; # Quan trọng: Host phải trùng domain
        }

        # --- CẤU HÌNH CHO PHP ---
        location /api/php/ {
            # 2. Thay URL dưới bằng URL công khai của Service PHP (vd: https://php-app-xyz.onrender.com)
            set $backend_php "https://server-side-1-wcdw.onrender.com"; 
            
            rewrite ^/api/php/(.*) /$1 break;
            
            proxy_pass $backend_php;
            
            proxy_ssl_server_name on;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            # proxy_set_header Host ... (Tự động lấy từ proxy_pass)
        }
        
        # Health check
        location / {
            return 200 'Gateway is Live via Public Internet!';
            add_header Content-Type text/plain;
        }
    }
}